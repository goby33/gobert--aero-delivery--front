name: 🩺 Code Analysis

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
      - hotfix/**
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  set-package:
    runs-on: [self-hosted, Linux, standard]
    name: ❔ Set package
    outputs:
      PACKAGE: ${{ steps.set-package.outputs.PACKAGE }}
    steps:
      - name: ❔ Get package type
        uses: adeo/iso--stock-it-easy--workflows/.github/actions/package-type@v2
        id: package
        with:
          SVC_GITHUB_TOKEN: ${{ secrets.SVC_GITHUB_TOKEN }}

      - name: 🌍 Set package type in env
        id: set-package
        run: echo "PACKAGE=${{ steps.package.outputs.PACKAGE }}" >> $GITHUB_OUTPUT

  sonarqube:
    runs-on: [self-hosted, Linux, standard]
    name: 🔍 SonarQube
    steps:
      - name: 🔍 SonarQube
        uses: adeo/iso--stock-it-easy--workflows/.github/actions/analysis/sonar@v2
        with:
          VAULT_ROLE_ID: ${{ secrets.VAULT_ROLE_ID }}
          VAULT_SECRET_ID: ${{ secrets.VAULT_SECRET_ID }}
          SVC_GITHUB_TOKEN: ${{ secrets.SVC_GITHUB_TOKEN }}
          BUILD_OPTIONS: '-Dsonar.exclusions="**/test/**, **/exceptions/**, **/errormanagement/**, **/pom.xml, **/data/models/stock/**"'

  lcov:
    name: 📶 lcov coverage
    needs: set-package
    if: ${{ needs.set-package.outputs.PACKAGE == 'flutter' && github.event_name == 'push' }}
    uses: adeo/iso--stock-it-easy--workflows/.github/workflows/analysis-lcov-coverage.yaml@v2
    secrets: inherit

  verygood-cli:
    name: 👨‍💻 Very Good CLI
    needs: set-package
    if: ${{ needs.set-package.outputs.PACKAGE == 'flutter' }}
    uses: adeo/iso--stock-it-easy--workflows/.github/workflows/analysis-verygood-cli.yaml@v2
    secrets: inherit
